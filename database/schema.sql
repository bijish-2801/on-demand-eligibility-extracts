/*
DROP TABLE ODER_REPORT_CONFIGS;
DROP TABLE ODER_REPORT_CRITERIA;
DROP TABLE ODER_REPORT_CRITERIA_GROUPS;
DROP TABLE ODER_REPORT_FIELDS;
DROP TABLE ODER_REPORTS;

DROP TABLE ODER_FILE_DELIMITERS;
DROP TABLE ODER_FILE_FORMATS;
DROP TABLE ODER_LOOKUP_CRITERIA_VALUES;
DROP TABLE ODER_LOOKUP_CRITERIA_FIELDS;
DROP TABLE ODER_LOOKUP_SELECT_FIELDS;
DROP TABLE ODER_OPERATORS;
DROP TABLE ODER_SCHEDULE_PARAMETERS;
DROP TABLE ODER_SFTP_SERVERS;

DROP TABLE ODER_SUB_LINES_OF_BUSINESS;
DROP TABLE ODER_LINES_OF_BUSINESS;
*/

-- Lines of Business
CREATE TABLE BL3468.ODER_LINES_OF_BUSINESS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR2(255) NOT NULL UNIQUE,
    DESCRIPTION VARCHAR2(255),
    PREFIX VARCHAR2(20),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Sub Lines of Business
CREATE TABLE BL3468.ODER_SUB_LINES_OF_BUSINESS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    LOB_ID NUMBER NOT NULL,
    NAME VARCHAR2(255) NOT NULL,
    DESCRIPTION VARCHAR2(255),
    PREFIX VARCHAR2(20),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (LOB_ID) REFERENCES BL3468.ODER_LINES_OF_BUSINESS(ID)
);

-- Lookup Fields for each Line of Business
CREATE TABLE BL3468.ODER_LOOKUP_SELECT_FIELDS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    LOB_ID NUMBER NOT NULL,
    FIELD_NAME VARCHAR2(255) NOT NULL,
    DISPLAY_NAME VARCHAR2(255) NOT NULL,
    FIELD_TYPE VARCHAR2(50) NOT NULL, -- VARCHAR, NUMBER, DATE, ETC.
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (LOB_ID) REFERENCES BL3468.ODER_LINES_OF_BUSINESS(ID),
    CONSTRAINT UNIQUE_LOB_FIELD_NAME UNIQUE (LOB_ID, FIELD_NAME)
);

-- Lookup Criteria Fields for each Line of Business
CREATE TABLE BL3468.ODER_LOOKUP_CRITERIA_FIELDS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    LOB_ID NUMBER NOT NULL,
    FIELD_NAME VARCHAR2(255) NOT NULL,
    DISPLAY_NAME VARCHAR2(255) NOT NULL,
    FIELD_TYPE VARCHAR2(50) NOT NULL, -- VARCHAR, NUMBER, DATE, ETC.
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (LOB_ID) REFERENCES BL3468.ODER_LINES_OF_BUSINESS(ID),
    CONSTRAINT UNIQUE_LOB_FIELD_NAME1 UNIQUE (LOB_ID, FIELD_NAME)
);

-- Lookup Criteria Values for each Criteria Fields
CREATE TABLE BL3468.ODER_LOOKUP_CRITERIA_VALUES (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    FIELD_ID NUMBER NOT NULL,
    FIELD_VALUE VARCHAR2(255) NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (FIELD_ID) REFERENCES BL3468.ODER_LOOKUP_CRITERIA_FIELDS(ID),
    CONSTRAINT UNIQUE_FIELD_VALUE UNIQUE (FIELD_ID, FIELD_VALUE)
);

-- Available Operators for Criteria
CREATE TABLE BL3468.ODER_OPERATORS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    OPERATOR_SYMBOL VARCHAR2(50) NOT NULL,
    OPERATOR_NAME VARCHAR2(255) NOT NULL,
    FIELD_TYPE VARCHAR2(50) NOT NULL,  -- VARCHAR, NUMBER, DATE
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT UNIQUE_OPERATOR_SYMBOL_FIELD_TYPE UNIQUE (OPERATOR_SYMBOL, FIELD_TYPE)
);

-- File Formats
CREATE TABLE BL3468.ODER_FILE_FORMATS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    FORMAT_NAME VARCHAR2(255) NOT NULL UNIQUE, -- CSV, TXT, XLSX, ETC.
    DESCRIPTION VARCHAR2(255),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- File Delimiters
CREATE TABLE BL3468.ODER_FILE_DELIMITERS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    DELIMITER_CHAR VARCHAR2(50) NOT NULL UNIQUE, 
    DELIMITER_NAME VARCHAR2(255) NOT NULL, -- COMMA, PIPE, TAB, ETC.
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- SFTP Servers
CREATE TABLE BL3468.ODER_SFTP_SERVERS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SERVER_NAME VARCHAR2(255) NOT NULL UNIQUE,
    DESCRIPTION VARCHAR2(255),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Schedule Parameters
CREATE TABLE BL3468.ODER_SCHEDULE_PARAMETERS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    FREQUENCY VARCHAR2(50) NOT NULL UNIQUE, -- DAILY, WEEKLY, MONTHLY, ETC.
    DESCRIPTION VARCHAR2(255),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Reports
CREATE TABLE BL3468.ODER_REPORTS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR2(255) NOT NULL,
    DESCRIPTION VARCHAR2(255),
    LOB_ID NUMBER NOT NULL,
    SUB_LOB_ID NUMBER NOT NULL,
    CREATED_BY NUMBER NOT NULL, -- USER ID
    QUERY_STATEMENT VARCHAR2(4000) NULL,
    IS_PUBLIC NUMBER(1) DEFAULT 0,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    EXTRACT_ID VARCHAR2(20 BYTE),
    FOREIGN KEY (LOB_ID) REFERENCES BL3468.ODER_LINES_OF_BUSINESS(ID),
    FOREIGN KEY (SUB_LOB_ID) REFERENCES BL3468.ODER_SUB_LINES_OF_BUSINESS(ID)
);

-- Report Fields (selected fields for each report in specific order)
CREATE TABLE BL3468.ODER_REPORT_FIELDS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    REPORT_ID NUMBER NOT NULL,
    LOOKUP_FIELD_ID NUMBER NOT NULL,
    DISPLAY_ORDER NUMBER NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (REPORT_ID) REFERENCES BL3468.ODER_REPORTS(ID),
    FOREIGN KEY (LOOKUP_FIELD_ID) REFERENCES BL3468.ODER_LOOKUP_SELECT_FIELDS(ID),
    CONSTRAINT UNIQUE_REPORT_FIELD UNIQUE (REPORT_ID, LOOKUP_FIELD_ID),
    CONSTRAINT UNIQUE_REPORT_DISPLAY_ORDER UNIQUE (REPORT_ID, DISPLAY_ORDER)
);

-- Report Configurations
CREATE TABLE BL3468.ODER_REPORT_CONFIGS (
    REPORT_ID NUMBER PRIMARY KEY,
    FILE_FORMAT_ID NUMBER NOT NULL,
    FILE_DELIMITER_ID NUMBER NOT NULL,
    SFTP_SERVER_ID NUMBER NOT NULL,
    SFTP_PATH VARCHAR2(255) NOT NULL,
    SCHEDULE_PARAMETER_ID NUMBER NOT NULL,
    REPORT_RUNTIMES VARCHAR2(5), 
    EMAIL_DL_LIST VARCHAR2(2000), 
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (REPORT_ID) REFERENCES ODER_REPORTS(ID),
    FOREIGN KEY (FILE_FORMAT_ID) REFERENCES BL3468.ODER_FILE_FORMATS(ID),
    FOREIGN KEY (FILE_DELIMITER_ID) REFERENCES BL3468.ODER_FILE_DELIMITERS(ID),
    FOREIGN KEY (SFTP_SERVER_ID) REFERENCES BL3468.ODER_SFTP_SERVERS(ID),
    FOREIGN KEY (SCHEDULE_PARAMETER_ID) REFERENCES BL3468.ODER_SCHEDULE_PARAMETERS(ID)
);

-- Report Criteria Groups (for handling AND/OR conditions)
CREATE TABLE BL3468.ODER_REPORT_CRITERIA_GROUPS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    REPORT_ID NUMBER NOT NULL,
    GROUP_ORDER NUMBER NOT NULL,
    OPERATOR VARCHAR2(3) NULL CHECK (OPERATOR IN ('AND', 'OR')),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (REPORT_ID) REFERENCES BL3468.ODER_REPORTS(ID),
    CONSTRAINT UNIQUE_REPORT_GROUP_ORDER UNIQUE (REPORT_ID, GROUP_ORDER)
);

-- Report Criteria
CREATE TABLE BL3468.ODER_REPORT_CRITERIA (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    REPORT_ID NUMBER NOT NULL,
    GROUP_ID NUMBER NOT NULL,
    LOOKUP_FIELD_ID NUMBER NOT NULL,
    OPERATOR_ID NUMBER NOT NULL,
    CRITERIA_VALUE VARCHAR2(255) NOT NULL,
    CRITERIA_ORDER NUMBER NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (REPORT_ID) REFERENCES BL3468.ODER_REPORTS(ID),
    FOREIGN KEY (GROUP_ID) REFERENCES BL3468.ODER_REPORT_CRITERIA_GROUPS(ID),
    FOREIGN KEY (LOOKUP_FIELD_ID) REFERENCES BL3468.ODER_LOOKUP_CRITERIA_FIELDS(ID),
    FOREIGN KEY (OPERATOR_ID) REFERENCES BL3468.ODER_OPERATORS(ID)
);

--   ALTER TABLE BL3468.ODER_REPORT_CRITERIA ADD FOREIGN KEY (LOOKUP_FIELD_ID) REFERENCES BL3468.ODER_LOOKUP_CRITERIA_FIELDS(ID);

-- Report Locks
CREATE TABLE BL3468.ODER_REPORT_LOCKS (
    LOCK_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    REPORT_ID NUMBER NOT NULL,
    USER_ID NUMBER NOT NULL,
    LOCKED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    EXPIRES_AT TIMESTAMP NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (REPORT_ID) REFERENCES BL3468.ODER_REPORTS(ID)
);
/
-- Triggers to update the updated_at timestamp
CREATE OR REPLACE TRIGGER BL3468.UPDATE_REPORTS_TIMESTAMP
BEFORE UPDATE ON BL3468.ODER_REPORTS FOR EACH ROW
BEGIN :NEW.UPDATED_AT := CURRENT_TIMESTAMP; END;
/
CREATE OR REPLACE TRIGGER BL3468.UPDATE_REPORT_FIELDS_TIMESTAMP
BEFORE UPDATE ON BL3468.ODER_REPORT_FIELDS FOR EACH ROW 
BEGIN :NEW.UPDATED_AT := CURRENT_TIMESTAMP; END;
/
CREATE OR REPLACE TRIGGER BL3468.UPDATE_REPORT_CRITERIA_TIMESTAMP
BEFORE UPDATE ON BL3468.ODER_REPORT_CRITERIA FOR EACH ROW 
BEGIN :NEW.UPDATED_AT := CURRENT_TIMESTAMP; END;
/
CREATE OR REPLACE TRIGGER BL3468.UPDATE_REPORT_CRITERIA_GROUPS_TIMESTAMP
BEFORE UPDATE ON BL3468.ODER_REPORT_CRITERIA_GROUPS FOR EACH ROW 
BEGIN :NEW.UPDATED_AT := CURRENT_TIMESTAMP; END;
/
CREATE OR REPLACE TRIGGER BL3468.UPDATE_SCHEDULE_PARAMETERS_TIMESTAMP
BEFORE UPDATE ON BL3468.ODER_SCHEDULE_PARAMETERS FOR EACH ROW 
BEGIN :NEW.UPDATED_AT := CURRENT_TIMESTAMP; END;
/
CREATE OR REPLACE TRIGGER BL3468.UPDATE_SFTP_SERVERS_TIMESTAMP
BEFORE UPDATE ON BL3468.ODER_SFTP_SERVERS FOR EACH ROW 
BEGIN :NEW.UPDATED_AT := CURRENT_TIMESTAMP; END;
/
CREATE OR REPLACE TRIGGER BL3468.UPDATE_FILE_DELIMITERS_TIMESTAMP
BEFORE UPDATE ON BL3468.ODER_FILE_DELIMITERS FOR EACH ROW 
BEGIN :NEW.UPDATED_AT := CURRENT_TIMESTAMP; END;
/
CREATE OR REPLACE TRIGGER BL3468.UPDATE_FILE_FORMATS_TIMESTAMP
BEFORE UPDATE ON BL3468.ODER_FILE_FORMATS FOR EACH ROW 
BEGIN :NEW.UPDATED_AT := CURRENT_TIMESTAMP; END;
/
CREATE OR REPLACE TRIGGER BL3468.UPDATE_OPERATORS_TIMESTAMP
BEFORE UPDATE ON BL3468.ODER_OPERATORS FOR EACH ROW 
BEGIN :NEW.UPDATED_AT := CURRENT_TIMESTAMP; END;
/
CREATE OR REPLACE TRIGGER BL3468.UPDATE_LOOKUP_FIELDS_TIMESTAMP
BEFORE UPDATE ON BL3468.ODER_LOOKUP_SELECT_FIELDS FOR EACH ROW 
BEGIN :NEW.UPDATED_AT := CURRENT_TIMESTAMP; END;
/
CREATE OR REPLACE TRIGGER BL3468.UPDATE_LINES_OF_BUSINESS_TIMESTAMP
BEFORE UPDATE ON BL3468.ODER_LINES_OF_BUSINESS FOR EACH ROW
BEGIN :NEW.UPDATED_AT := CURRENT_TIMESTAMP; END;
/
CREATE OR REPLACE TRIGGER BL3468.ODER_REPORT_CONFIGS_TIMESTAMP
BEFORE UPDATE ON BL3468.ODER_REPORT_CONFIGS FOR EACH ROW
BEGIN :NEW.UPDATED_AT := CURRENT_TIMESTAMP; END;
/

-- Create index for faster lock checks
CREATE INDEX idx_report_locks_expiry ON BL3468.ODER_REPORT_LOCKS(REPORT_ID, EXPIRES_AT);

-- Add trigger for updated_at
CREATE OR REPLACE TRIGGER BL3468.UPDATE_REPORT_LOCKS_TIMESTAMP
BEFORE UPDATE ON BL3468.ODER_REPORT_LOCKS FOR EACH ROW
BEGIN :NEW.UPDATED_AT := CURRENT_TIMESTAMP; END;
/
-- Create procedure to clean up expired locks
CREATE OR REPLACE PROCEDURE BL3468.CLEANUP_EXPIRED_LOCKS AS
BEGIN
    DELETE FROM BL3468.ODER_REPORT_LOCKS
    WHERE EXPIRES_AT < CURRENT_TIMESTAMP;
    COMMIT;
END;
/